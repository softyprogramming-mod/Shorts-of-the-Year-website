<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin · Shorts of the Year</title>
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://softy-api-phi.vercel.app https://vimeo.com; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self';">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface2: #1e1e1e;
      --border: #2a2a2a;
      --text: #f0f0f0;
      --text-dim: #888;
      --accent: #e8e8e8;
      --red: #e05252;
      --green: #52c97a;
      --yellow: #e0c252;
      --blue: #5294e0;
      --orange: #e07a52;
      --radius: 8px;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }

    /* ── LOGIN ── */
    #loginScreen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; }

    .login-box {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 3rem 2.5rem; width: 100%; max-width: 380px; text-align: center;
    }
    .login-box h1 { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.4rem; letter-spacing: -0.02em; }
    .login-box p { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 2rem; }
    .login-box input {
      width: 100%; background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius); color: var(--text); font-size: 1rem;
      padding: 0.75rem 1rem; margin-bottom: 1rem; outline: none; transition: border-color 0.2s;
      text-align: center; letter-spacing: 0.1em;
    }
    .login-box input:focus { border-color: #555; }
    .error-msg { color: var(--red); font-size: 0.8rem; margin-top: 0.5rem; min-height: 1rem; }

    /* ── BUTTONS ── */
    .btn {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.65rem 1.2rem; border-radius: var(--radius); border: none;
      cursor: pointer; font-size: 0.875rem; font-weight: 500;
      transition: opacity 0.15s, transform 0.1s; text-decoration: none;
    }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #000; width: 100%; justify-content: center; padding: 0.75rem; font-size: 0.95rem; }
    .btn-primary:hover { opacity: 0.85; }
    .btn-logout { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
    .btn-logout:hover { color: var(--text); border-color: #555; }
    .btn-edit { background: var(--surface2); color: var(--text); border: 1px solid var(--border); font-size: 0.78rem; padding: 0.4rem 0.75rem; }
    .btn-edit:hover { border-color: #555; }
    .btn-add { background: var(--accent); color: #000; border: none; font-weight: 600; }
    .btn-add:hover { opacity: 0.85; }
    .btn-toggle { background: transparent; border: 1px solid var(--border); font-size: 0.78rem; padding: 0.4rem 0.75rem; }
    .btn-toggle.is-live { color: var(--yellow); border-color: rgba(224,194,82,0.3); }
    .btn-toggle.is-hidden { color: var(--green); border-color: rgba(82,201,122,0.3); }
    .btn-delete { background: transparent; color: var(--red); border: 1px solid rgba(224,82,82,0.3); font-size: 0.78rem; padding: 0.4rem 0.75rem; }
    .btn-delete:hover { background: rgba(224,82,82,0.1); }
    .btn-approve { background: transparent; color: var(--green); border: 1px solid rgba(82,201,122,0.3); font-size: 0.78rem; padding: 0.4rem 0.75rem; }
    .btn-approve:hover { background: rgba(82,201,122,0.1); }
    .btn-reject { background: transparent; color: var(--red); border: 1px solid rgba(224,82,82,0.3); font-size: 0.78rem; padding: 0.4rem 0.75rem; }
    .btn-reject:hover { background: rgba(224,82,82,0.1); }
    .btn-cancel { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
    .btn-cancel:hover { color: var(--text); }
    .btn-save { background: var(--accent); color: #000; }
    .btn-save:hover { opacity: 0.85; }
    .btn-confirm-delete { background: var(--red); color: #fff; border: none; }
    .btn-confirm-delete:hover { opacity: 0.85; }

    /* ── ADMIN APP ── */
    #adminApp { display: none; }

    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    header h1 { font-size: 1rem; font-weight: 600; letter-spacing: -0.01em; }
    header span { font-size: 0.75rem; color: var(--text-dim); background: var(--surface2); border: 1px solid var(--border); border-radius: 99px; padding: 0.25rem 0.75rem; }

    /* ── TABS ── */
    .tabs {
      display: flex; gap: 0; border-bottom: 1px solid var(--border);
      padding: 0 2rem; background: var(--surface);
    }
    .tab-btn {
      background: none; border: none; color: var(--text-dim); cursor: pointer;
      font-size: 0.85rem; font-family: var(--font); padding: 0.85rem 1.25rem;
      border-bottom: 2px solid transparent; margin-bottom: -1px;
      transition: color 0.15s, border-color 0.15s; display: flex; align-items: center; gap: 0.5rem;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { color: var(--text); border-bottom-color: var(--accent); }
    .tab-count {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 99px; font-size: 0.7rem; padding: 0.1rem 0.5rem; color: var(--text-dim);
    }
    .tab-count.pending-count { background: rgba(224,122,82,0.15); border-color: rgba(224,122,82,0.3); color: var(--orange); }

    /* ── TOOLBAR ── */
    .toolbar {
      padding: 1.25rem 2rem; display: flex; align-items: center; gap: 1rem;
      border-bottom: 1px solid var(--border); flex-wrap: wrap;
    }
    .search-input {
      background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
      color: var(--text); font-size: 0.875rem; padding: 0.55rem 0.9rem; outline: none;
      width: 240px; transition: border-color 0.2s;
    }
    .search-input:focus { border-color: #555; }
    .filter-select {
      background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
      color: var(--text); font-size: 0.875rem; padding: 0.55rem 0.9rem; outline: none; cursor: pointer;
    }
    .count-badge { margin-left: auto; font-size: 0.8rem; color: var(--text-dim); }

    /* ── TABLE ── */
    .table-wrap { padding: 1.5rem 2rem; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    thead th {
      text-align: left; padding: 0.6rem 0.75rem; color: var(--text-dim); font-weight: 500;
      font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em;
      border-bottom: 1px solid var(--border); white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
    tbody tr:hover { background: var(--surface); }
    tbody td { padding: 0.85rem 0.75rem; vertical-align: middle; }
    tbody tr.row-draggable { cursor: grab; }
    tbody tr.row-draggable.dragging { opacity: 0.5; }
    tbody tr.row-drop-target { outline: 1px dashed #666; outline-offset: -2px; }
    .td-drag { width: 28px; color: var(--text-dim); text-align: center; user-select: none; }
    .drag-handle { font-size: 1rem; line-height: 1; display: inline-block; opacity: 0.65; }
    .reorder-hint { font-size: 0.75rem; color: var(--text-dim); margin-left: 0.5rem; }

    .td-thumb img { width: 72px; height: 42px; object-fit: cover; border-radius: 4px; display: block; background: var(--surface2); }
    .td-title strong { display: block; font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .td-title small { color: var(--text-dim); font-size: 0.78rem; }

    /* ── BADGES ── */
    .badge { display: inline-block; padding: 0.2rem 0.55rem; border-radius: 99px; font-size: 0.72rem; font-weight: 500; letter-spacing: 0.02em; }
    .badge-live { background: rgba(82,201,122,0.15); color: var(--green); }
    .badge-hidden { background: rgba(224,82,82,0.15); color: var(--red); }
    .badge-pending { background: rgba(224,122,82,0.15); color: var(--orange); }
    .badge-genre { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }

    .actions { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }

    /* ── SUBMISSION DETAIL ── */
    .sub-detail { font-size: 0.78rem; color: var(--text-dim); max-width: 280px; }
    .sub-logline { font-size: 0.78rem; color: var(--text-dim); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ── LOADING / EMPTY ── */
    .state-msg { text-align: center; padding: 4rem 2rem; color: var(--text-dim); font-size: 0.9rem; }

    /* ── EDIT MODAL ── */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 200; padding: 1rem; }
    .modal-backdrop.open { display: flex; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 640px; max-height: 90vh; overflow-y: auto; padding: 2rem; }
    .modal h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem; letter-spacing: -0.01em; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: 0.75rem; color: var(--text-dim); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
    .form-group input, .form-group textarea, .form-group select { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 0.875rem; padding: 0.6rem 0.8rem; outline: none; font-family: var(--font); transition: border-color 0.2s; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: #555; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
    .inline-field-action { margin-top: 0.5rem; justify-content: flex-start; }

    /* ── APPROVE CONFIRM ── */
    .confirm-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 300; padding: 1rem; }
    .confirm-backdrop.open { display: flex; }
    .confirm-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 400px; width: 100%; }
    .confirm-box h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .confirm-box p { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.75rem; }
    .confirm-box .review-preview { font-size: 0.8rem; color: var(--text-dim); background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; margin-bottom: 1.25rem; line-height: 1.5; font-style: italic; }
    .confirm-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
    .btn-confirm-approve { background: var(--green); color: #000; border: none; font-weight: 600; }
    .btn-confirm-approve:hover { opacity: 0.85; }

    /* ── TOAST ── */
    #toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem 1.25rem; font-size: 0.875rem; opacity: 0; transform: translateY(8px); transition: opacity 0.25s, transform 0.25s; z-index: 400; pointer-events: none; }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { border-color: rgba(82,201,122,0.4); color: var(--green); }
    #toast.error { border-color: rgba(224,82,82,0.4); color: var(--red); }

    @media (max-width: 600px) {
      header, .toolbar, .table-wrap { padding-left: 1rem; padding-right: 1rem; }
      .form-grid { grid-template-columns: 1fr; }
      .tabs { padding: 0 1rem; }
    }
  </style>
</head>
<body>

<!-- ══ LOGIN ══ -->
<div id="loginScreen">
  <div class="login-box">
    <h1>Shorts of the Year</h1>
    <p>Admin access only</p>
    <input type="password" id="pwInput" placeholder="Password" autocomplete="current-password">
    <button class="btn btn-primary" id="loginBtn">Enter</button>
    <div class="error-msg" id="loginError"></div>
  </div>
</div>

<!-- ══ ADMIN APP ══ -->
<div id="adminApp">

  <header>
    <h1>⬡ Softy Admin</h1>
    <div style="display:flex;gap:.75rem;align-items:center">
      <span id="filmCountLabel">— films</span>
      <button class="btn btn-logout" id="logoutBtn">Log out</button>
    </div>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" id="tabFilms" onclick="switchTab('films')">
      Films <span class="tab-count" id="filmsTabCount">0</span>
    </button>
    <button class="tab-btn" id="tabSubmissions" onclick="switchTab('submissions')">
      Submissions <span class="tab-count pending-count" id="subsTabCount">0</span>
    </button>
  </div>

  <!-- FILMS PANEL -->
  <div id="panelFilms">
    <div class="toolbar">
      <button class="btn btn-add" id="addFilmBtn">Add</button>
      <input class="search-input" type="text" placeholder="Search title, director…" id="searchInput">
      <select class="filter-select" id="filterGenre">
        <option value="">All genres</option>
        <option>Drama</option><option>Comedy</option><option>Documentary</option>
        <option>Horror</option><option>Sci-Fi</option><option>Thriller</option>
        <option>Animation</option><option>Experimental</option>
      </select>
      <select class="filter-select" id="filterStatus">
        <option value="">All statuses</option>
        <option value="live">Live</option>
        <option value="hidden">Hidden</option>
      </select>
    </div>
    <div class="table-wrap">
      <div id="tableState" class="state-msg">Loading films…</div>
      <table id="filmsTable" style="display:none">
        <thead>
          <tr>
            <th></th><th></th><th>Title / Director</th><th>Genre</th>
            <th>Runtime</th><th>Status</th><th>Date</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="filmsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- SUBMISSIONS PANEL -->
  <div id="panelSubmissions" style="display:none">
    <div class="toolbar">
      <input class="search-input" type="text" placeholder="Search title, director…" id="subSearchInput">
    </div>
    <div class="table-wrap">
      <div id="subTableState" class="state-msg">Loading submissions…</div>
      <table id="subsTable" style="display:none">
        <thead>
          <tr>
            <th>Title / Director</th><th>Genre</th><th>Runtime</th>
            <th>Logline</th><th>Submitted</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="subsBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ══ EDIT MODAL ══ -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <h2 id="modalTitle">Edit Film</h2>
    <div class="form-grid" id="editForm"></div>
    <div class="modal-actions">
      <button class="btn btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn btn-save" id="modalSave">Save changes</button>
    </div>
  </div>
</div>

<!-- ══ APPROVE CONFIRM ══ -->
<div class="confirm-backdrop" id="approveModal">
  <div class="confirm-box">
    <h3>Approve submission?</h3>
    <p id="approveFilmName"></p>
    <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.5rem;">Generated review:</p>
    <div class="review-preview" id="approveReviewPreview"></div>
    <div class="confirm-actions">
      <button class="btn btn-cancel" id="approveCancel">Cancel</button>
      <button class="btn btn-confirm-approve" id="approveConfirm">✓ Approve &amp; Go Live</button>
    </div>
  </div>
</div>

<!-- ══ DELETE CONFIRM ══ -->
<div class="confirm-backdrop" id="confirmModal">
  <div class="confirm-box">
    <h3>Delete film?</h3>
    <p id="confirmFilmName">This cannot be undone.</p>
    <div class="confirm-actions">
      <button class="btn btn-cancel" id="confirmCancel">Cancel</button>
      <button class="btn btn-confirm-delete" id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<!-- ══ TOAST ══ -->
<div id="toast"></div>

<script>
// ══════════════════════════════════════════════════════════════
// CONFIG
// ══════════════════════════════════════════════════════════════
const API_BASE = 'https://softy-api-phi.vercel.app/api';
const MAX_LOGIN_ATTEMPTS = 5;
const LOCKOUT_MS = 5 * 60 * 1000;

// ══════════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════════
let films = [];
let submissions = [];
let editingFilm = null;
let modalReadOnly = false;
let deletingId = null;
let approvingSubmission = null;
let approveReviewText = '';
let adminPassword = '';
let activeTab = 'films';
let failedLoginAttempts = 0;
let lockoutUntil = 0;
let isCreatingFilm = false;
let draggedFilmId = null;
let savingReorder = false;

// ══════════════════════════════════════════════════════════════
// LOGIN
// ══════════════════════════════════════════════════════════════
document.getElementById('loginBtn').addEventListener('click', () => { void tryLogin(); });
document.getElementById('pwInput').addEventListener('keydown', e => { if (e.key === 'Enter') void tryLogin(); });

async function tryLogin() {
  const now = Date.now();
  if (lockoutUntil > now) {
    const secs = Math.ceil((lockoutUntil - now) / 1000);
    document.getElementById('loginError').textContent = `Too many attempts. Try again in ${secs}s.`;
    return;
  }

  const val = document.getElementById('pwInput').value.trim();
  if (!val) {
    document.getElementById('loginError').textContent = 'Enter password.';
    return;
  }

  document.getElementById('loginBtn').disabled = true;
  document.getElementById('loginError').textContent = 'Checking credentials…';

  try {
    const ok = await verifyAdminPassword(val);
    if (!ok) {
      failedLoginAttempts += 1;
      if (failedLoginAttempts >= MAX_LOGIN_ATTEMPTS) {
        lockoutUntil = Date.now() + LOCKOUT_MS;
        failedLoginAttempts = 0;
      }
      throw new Error('invalid');
    }

    failedLoginAttempts = 0;
    lockoutUntil = 0;
    adminPassword = val;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminApp').style.display = 'block';
    void loadFilms();
    void loadSubmissions();
  } catch (_) {
    document.getElementById('loginError').textContent = 'Incorrect password.';
    document.getElementById('pwInput').value = '';
    document.getElementById('pwInput').focus();
  } finally {
    document.getElementById('loginBtn').disabled = false;
  }
}

async function verifyAdminPassword(password) {
  try {
    const res = await fetch(`${API_BASE}/admin?action=list`, {
      headers: { 'x-admin-password': password }
    });
    return res.ok;
  } catch (_) {
    return false;
  }
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  adminPassword = '';
  films = [];
  submissions = [];
  document.getElementById('adminApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('pwInput').value = '';
});

// ══════════════════════════════════════════════════════════════
// TABS
// ══════════════════════════════════════════════════════════════
function switchTab(tab) {
  activeTab = tab;
  document.getElementById('panelFilms').style.display = tab === 'films' ? 'block' : 'none';
  document.getElementById('panelSubmissions').style.display = tab === 'submissions' ? 'block' : 'none';
  document.getElementById('tabFilms').classList.toggle('active', tab === 'films');
  document.getElementById('tabSubmissions').classList.toggle('active', tab === 'submissions');
}

// ══════════════════════════════════════════════════════════════
// LOAD FILMS
// ══════════════════════════════════════════════════════════════
async function loadFilms() {
  document.getElementById('tableState').textContent = 'Loading films…';
  document.getElementById('filmsTable').style.display = 'none';
  try {
    const res = await fetch(`${API_BASE}/admin?action=list`, {
      headers: { 'x-admin-password': adminPassword }
    });
    if (!res.ok) throw new Error('Auth failed');
    const data = await res.json();
    films = (data.films || []).filter(f => !f.pending);
    renderFilmsTable(films);
  } catch (err) {
    document.getElementById('tableState').textContent = '⚠ Could not load films.';
  }
}

// ══════════════════════════════════════════════════════════════
// LOAD SUBMISSIONS
// ══════════════════════════════════════════════════════════════
async function loadSubmissions() {
  document.getElementById('subTableState').textContent = 'Loading submissions…';
  document.getElementById('subsTable').style.display = 'none';
  try {
    const res = await fetch(`${API_BASE}/admin?action=list`, {
      headers: { 'x-admin-password': adminPassword }
    });
    if (!res.ok) throw new Error();
    const data = await res.json();
    submissions = (data.films || []).filter(f => f.pending === true);
    renderSubsTable(submissions);
    document.getElementById('subsTabCount').textContent = submissions.length;
  } catch (err) {
    document.getElementById('subTableState').textContent = '⚠ Could not load submissions.';
  }
}

// ══════════════════════════════════════════════════════════════
// RENDER FILMS TABLE
// ══════════════════════════════════════════════════════════════
function renderFilmsTable(list) {
  const body = document.getElementById('filmsBody');
  while (body.firstChild) body.removeChild(body.firstChild);

  document.getElementById('filmsTabCount').textContent = films.length;
  document.getElementById('filmCountLabel').textContent = `${films.length} film${films.length !== 1 ? 's' : ''}`;

  if (list.length === 0) {
    document.getElementById('tableState').style.display = 'block';
    document.getElementById('tableState').textContent = 'No films found.';
    document.getElementById('filmsTable').style.display = 'none';
    return;
  }

  document.getElementById('tableState').style.display = 'none';
  document.getElementById('filmsTable').style.display = 'table';
  const reorderEnabled = canReorderFilmsInCurrentView();
  document.getElementById('filmCountLabel').innerHTML = `${films.length} film${films.length !== 1 ? 's' : ''}${reorderEnabled ? '<span class="reorder-hint">Drag to reorder · top live film = homepage hero</span>' : ''}`;
  list.forEach(film => body.appendChild(createFilmRow(film)));
}

function createFilmRow(film) {
  const tr = document.createElement('tr');
  const mongoId = film._id?.$oid || film._id?.toString() || film._id;
  tr.dataset.id = mongoId;
  const reorderEnabled = canReorderFilmsInCurrentView();
  if (reorderEnabled) {
    tr.classList.add('row-draggable');
    tr.draggable = true;
    tr.addEventListener('dragstart', onFilmRowDragStart);
    tr.addEventListener('dragover', onFilmRowDragOver);
    tr.addEventListener('dragleave', onFilmRowDragLeave);
    tr.addEventListener('drop', onFilmRowDrop);
    tr.addEventListener('dragend', onFilmRowDragEnd);
  }

  const tdDrag = document.createElement('td');
  tdDrag.className = 'td-drag';
  const dragHandle = document.createElement('span');
  dragHandle.className = 'drag-handle';
  dragHandle.textContent = reorderEnabled ? '⋮⋮' : '';
  tdDrag.appendChild(dragHandle);
  tr.appendChild(tdDrag);

  const tdThumb = document.createElement('td');
  tdThumb.className = 'td-thumb';
  const img = document.createElement('img');
  img.src = film.thumbnail || '';
  img.alt = '';
  img.loading = 'lazy';
  tdThumb.appendChild(img);
  tr.appendChild(tdThumb);

  const tdTitle = document.createElement('td');
  tdTitle.className = 'td-title';
  const strong = document.createElement('strong');
  strong.textContent = film.title;
  const small = document.createElement('small');
  small.textContent = film.director;
  tdTitle.appendChild(strong);
  tdTitle.appendChild(small);
  tr.appendChild(tdTitle);

  const tdGenre = document.createElement('td');
  const genreBadge = document.createElement('span');
  genreBadge.className = 'badge badge-genre';
  genreBadge.textContent = film.genre || '—';
  tdGenre.appendChild(genreBadge);
  tr.appendChild(tdGenre);

  const tdRuntime = document.createElement('td');
  tdRuntime.textContent = film.runtime || '—';
  tdRuntime.style.color = 'var(--text-dim)';
  tr.appendChild(tdRuntime);

  const tdStatus = document.createElement('td');
  const statusBadge = document.createElement('span');
  statusBadge.className = film.live ? 'badge badge-live' : 'badge badge-hidden';
  statusBadge.textContent = film.live ? 'Live' : 'Hidden';
  tdStatus.appendChild(statusBadge);
  tr.appendChild(tdStatus);

  const tdDate = document.createElement('td');
  tdDate.style.color = 'var(--text-dim)';
  tdDate.style.fontSize = '0.8rem';
  tdDate.textContent = film.timestamp
    ? new Date(film.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    : '—';
  tr.appendChild(tdDate);

  const tdActions = document.createElement('td');
  const actions = document.createElement('div');
  actions.className = 'actions';

  const editBtn = document.createElement('button');
  editBtn.className = 'btn btn-edit';
  editBtn.textContent = 'Edit';
  editBtn.addEventListener('click', () => openEditModal(film));

  const toggleBtn = document.createElement('button');
  toggleBtn.className = film.live ? 'btn btn-toggle is-live' : 'btn btn-toggle is-hidden';
  toggleBtn.textContent = film.live ? 'Hide' : 'Show';
  toggleBtn.addEventListener('click', () => toggleFilm(mongoId, film.live, tr));

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'btn btn-delete';
  deleteBtn.textContent = 'Delete';
  deleteBtn.addEventListener('click', () => openConfirmDelete(mongoId, film.title));

  actions.appendChild(editBtn);
  actions.appendChild(toggleBtn);
  actions.appendChild(deleteBtn);
  tdActions.appendChild(actions);
  tr.appendChild(tdActions);

  return tr;
}

function getFilmId(film) {
  return film && (film._id?.$oid || film._id?.toString() || film._id);
}

function canReorderFilmsInCurrentView() {
  const q = document.getElementById('searchInput')?.value.trim();
  const genre = document.getElementById('filterGenre')?.value;
  const status = document.getElementById('filterStatus')?.value;
  return activeTab === 'films' && !q && !genre && !status && films.length > 1;
}

function onFilmRowDragStart(e) {
  draggedFilmId = e.currentTarget.dataset.id;
  e.currentTarget.classList.add('dragging');
  if (e.dataTransfer) {
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedFilmId || '');
  }
}

function onFilmRowDragOver(e) {
  e.preventDefault();
  if (!draggedFilmId || draggedFilmId === e.currentTarget.dataset.id) return;
  e.currentTarget.classList.add('row-drop-target');
  if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
}

function onFilmRowDragLeave(e) {
  e.currentTarget.classList.remove('row-drop-target');
}

function onFilmRowDrop(e) {
  e.preventDefault();
  const targetRow = e.currentTarget;
  targetRow.classList.remove('row-drop-target');
  const targetId = targetRow.dataset.id;
  const sourceId = draggedFilmId || (e.dataTransfer && e.dataTransfer.getData('text/plain'));
  if (!sourceId || !targetId || sourceId === targetId) return;
  if (!moveFilmInOrder(sourceId, targetId)) return;
  applyFilters();
  void saveFilmOrder();
}

function onFilmRowDragEnd(e) {
  e.currentTarget.classList.remove('dragging');
  document.querySelectorAll('#filmsBody tr').forEach(row => row.classList.remove('row-drop-target', 'dragging'));
  draggedFilmId = null;
}

function moveFilmInOrder(sourceId, targetId) {
  const sourceIdx = films.findIndex(f => getFilmId(f) === sourceId);
  const targetIdx = films.findIndex(f => getFilmId(f) === targetId);
  if (sourceIdx < 0 || targetIdx < 0 || sourceIdx === targetIdx) return false;
  const [moved] = films.splice(sourceIdx, 1);
  films.splice(targetIdx, 0, moved);
  films.forEach((film, idx) => { film.sortOrder = idx; });
  return true;
}

async function saveFilmOrder() {
  if (savingReorder) return;
  savingReorder = true;
  try {
    const ids = films.map(getFilmId).filter(Boolean);
    const res = await fetch(`${API_BASE}/admin?action=reorder`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-admin-password': adminPassword
      },
      body: JSON.stringify({ ids })
    });
    if (!res.ok) throw new Error();
    showToast('Film order saved', 'success');
  } catch (_) {
    showToast('Failed to save film order', 'error');
    void loadFilms();
  } finally {
    savingReorder = false;
  }
}

// ══════════════════════════════════════════════════════════════
// RENDER SUBMISSIONS TABLE
// ══════════════════════════════════════════════════════════════
function renderSubsTable(list) {
  const body = document.getElementById('subsBody');
  while (body.firstChild) body.removeChild(body.firstChild);

  if (list.length === 0) {
    document.getElementById('subTableState').style.display = 'block';
    document.getElementById('subTableState').textContent = 'No pending submissions.';
    document.getElementById('subsTable').style.display = 'none';
    return;
  }

  document.getElementById('subTableState').style.display = 'none';
  document.getElementById('subsTable').style.display = 'table';
  list.forEach(sub => body.appendChild(createSubRow(sub)));
}

function createSubRow(sub) {
  const tr = document.createElement('tr');
  const mongoId = sub._id?.$oid || sub._id?.toString() || sub._id;

  const tdTitle = document.createElement('td');
  tdTitle.className = 'td-title';
  const strong = document.createElement('strong');
  strong.textContent = sub.title || '—';
  const small = document.createElement('small');
  small.textContent = sub.director || '—';
  if (sub.email) {
    small.textContent += ' · ' + sub.email;
  }
  tdTitle.appendChild(strong);
  tdTitle.appendChild(small);
  tr.appendChild(tdTitle);

  const tdGenre = document.createElement('td');
  const genreBadge = document.createElement('span');
  genreBadge.className = 'badge badge-genre';
  genreBadge.textContent = sub.genre || '—';
  tdGenre.appendChild(genreBadge);
  tr.appendChild(tdGenre);

  const tdRuntime = document.createElement('td');
  tdRuntime.textContent = (sub.runtime || '—') + (sub.runtime ? ' min' : '');
  tdRuntime.style.color = 'var(--text-dim)';
  tr.appendChild(tdRuntime);

  const tdLogline = document.createElement('td');
  const loglineSpan = document.createElement('span');
  loglineSpan.className = 'sub-logline';
  loglineSpan.textContent = sub.logline || '—';
  loglineSpan.title = sub.logline || '';
  tdLogline.appendChild(loglineSpan);
  tr.appendChild(tdLogline);

  const tdDate = document.createElement('td');
  tdDate.style.color = 'var(--text-dim)';
  tdDate.style.fontSize = '0.8rem';
  tdDate.textContent = sub.timestamp
    ? new Date(sub.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    : '—';
  tr.appendChild(tdDate);

  const tdActions = document.createElement('td');
  const actions = document.createElement('div');
  actions.className = 'actions';

  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn btn-edit';
  viewBtn.textContent = 'View';
  viewBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    openEditModal(sub, { readOnly: true, titlePrefix: 'Submission' });
  });

  const approveBtn = document.createElement('button');
  approveBtn.className = 'btn btn-approve';
  approveBtn.textContent = '✓ Approve';
  approveBtn.addEventListener('click', () => openApproveModal(sub, mongoId));

  const rejectBtn = document.createElement('button');
  rejectBtn.className = 'btn btn-reject';
  rejectBtn.textContent = 'Reject';
  rejectBtn.addEventListener('click', () => rejectSubmission(mongoId, sub.title, tr));

  actions.appendChild(viewBtn);
  actions.appendChild(approveBtn);
  actions.appendChild(rejectBtn);
  tdActions.appendChild(actions);
  tr.appendChild(tdActions);

  // Click anywhere on submission row (except action buttons) to view full details.
  tr.style.cursor = 'pointer';
  tr.addEventListener('click', (e) => {
    if (e.target.closest('button')) return;
    openEditModal(sub, { readOnly: true, titlePrefix: 'Submission' });
  });

  return tr;
}

// ══════════════════════════════════════════════════════════════
// APPROVE SUBMISSION
// ══════════════════════════════════════════════════════════════
function openApproveModal(sub, mongoId) {
  approvingSubmission = { sub, mongoId };
  approveReviewText = generateReview(sub);
  document.getElementById('approveFilmName').textContent =
    `"${sub.title}" by ${sub.director} will go live immediately and an acceptance email will be sent.`;
  document.getElementById('approveReviewPreview').textContent = approveReviewText;
  document.getElementById('approveModal').classList.add('open');
}

document.getElementById('approveCancel').addEventListener('click', () => {
  document.getElementById('approveModal').classList.remove('open');
  approvingSubmission = null;
  approveReviewText = '';
});

document.getElementById('approveConfirm').addEventListener('click', async () => {
  if (!approvingSubmission) return;
  const { sub, mongoId } = approvingSubmission;
  const btn = document.getElementById('approveConfirm');
  btn.disabled = true;
  btn.textContent = 'Approving…';

  try {
    const res = await fetch(`${API_BASE}/admin?action=approve&id=${mongoId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'x-admin-password': adminPassword
      },
      body: JSON.stringify({ review: approveReviewText })
    });
    if (!res.ok) throw new Error();

    document.getElementById('approveModal').classList.remove('open');
    approvingSubmission = null;
    approveReviewText = '';

    // Remove from local submissions list
    submissions = submissions.filter(s => {
      const sid = s._id?.$oid || s._id?.toString() || s._id;
      return sid !== mongoId;
    });
    renderSubsTable(submissions);
    document.getElementById('subsTabCount').textContent = submissions.length;

    // Reload films tab to show newly approved film
    await loadFilms();
    showToast('Film approved and now live!', 'success');
  } catch {
    showToast('Failed to approve — check API supports action=approve', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = '✓ Approve & Go Live';
  }
});

async function rejectSubmission(mongoId, title, tr) {
  if (!confirm(`Reject and delete "${title}"? This cannot be undone.`)) return;
  try {
    const res = await fetch(`${API_BASE}/admin?action=delete&id=${mongoId}`, {
      method: 'DELETE',
      headers: { 'x-admin-password': adminPassword }
    });
    if (!res.ok) throw new Error();
    submissions = submissions.filter(s => {
      const sid = s._id?.$oid || s._id?.toString() || s._id;
      return sid !== mongoId;
    });
    renderSubsTable(submissions);
    document.getElementById('subsTabCount').textContent = submissions.length;
    showToast('Submission rejected', 'success');
  } catch {
    showToast('Failed to reject', 'error');
  }
}

// ══════════════════════════════════════════════════════════════
// SUBMISSIONS SEARCH
// ══════════════════════════════════════════════════════════════
document.getElementById('subSearchInput').addEventListener('input', function() {
  const q = this.value.toLowerCase().trim();
  const filtered = submissions.filter(s =>
    !q || (s.title || '').toLowerCase().includes(q) || (s.director || '').toLowerCase().includes(q)
  );
  renderSubsTable(filtered);
});

// ══════════════════════════════════════════════════════════════
// REVIEW GENERATION (mirrors GAS logic)
// ══════════════════════════════════════════════════════════════
const GENRE_ADJECTIVES_CLIENT = {
  'Drama': ['poignant','powerful','intimate','affecting','moving','thoughtful','restrained','meditative','character-driven','somber'],
  'Comedy': ['sharp','witty','clever','observational','charming','incisive','dry','deadpan','satirical','absurdist'],
  'Documentary': ['revealing','illuminating','compelling','insightful','engaging','thought-provoking','observational','investigative','patient'],
  'Horror': ['unsettling','atmospheric','tense','chilling','psychological','nightmarish','brooding','ominous','disturbing'],
  'Sci-Fi': ['imaginative','cerebral','visionary','ambitious','conceptual','speculative','futuristic','philosophical'],
  'Thriller': ['gripping','taut','suspenseful','intense','riveting','propulsive','methodical','nerve-wracking'],
  'Animation': ['inventive','visually stunning','creative','imaginative','beautifully crafted','artistic','handcrafted','stylized'],
  'Experimental': ['bold','audacious','unconventional','avant-garde','challenging','innovative','formally daring'],
  'Romance': ['tender','bittersweet','yearning','melancholic','sincere'],
  'Action': ['kinetic','muscular','high-octane','propulsive','viscerally staged']
};

const OPENINGS_CLIENT = [
  '{DIRECTOR} brings us {TITLE}, a {GENRE_ADJ} exploration',
  'In {TITLE}, director {DIRECTOR} crafts a {GENRE_ADJ} narrative',
  '{TITLE} marks {DIRECTOR} as a filmmaker with a distinct voice',
  'With {TITLE}, {DIRECTOR} delivers a {GENRE_ADJ} work',
  '{DIRECTOR}\'s {TITLE} is a {GENRE_ADJ} achievement',
  '{TITLE} finds {DIRECTOR} in complete command',
  '{DIRECTOR} demonstrates remarkable control in {TITLE}',
  '{TITLE} marks an impressive {GENRE} entry from {DIRECTOR}',
  '{DIRECTOR} creates a powerful statement with {TITLE}',
  'In {TITLE}, {DIRECTOR} balances {QUALITY} with {QUALITY}',
];

const MIDDLES_CLIENT = [
  'that resonates with authentic emotion','through intimate cinematography and nuanced performances',
  'with remarkable visual sophistication','while maintaining a delicate balance between form and content',
  'with confident pacing and precise editing','through carefully composed frames',
  'that builds tension masterfully','with a keen sense of atmosphere',
  'while maintaining emotional honesty','through layered storytelling',
  'with precise shot composition','while trusting the audience\'s intelligence',
  'through confident direction','that feels fresh and original',
  'with authentic emotional beats','while exploring timely themes',
];

const CLOSINGS_CLIENT = [
  'The film marks {DIRECTOR} as a talent to watch.',
  'A confident work that announces a promising filmmaker.',
  'An impressive achievement in {GENRE} filmmaking.',
  '{DIRECTOR} proves to be a distinctive voice in contemporary cinema.',
  'The result is a film that lingers long after viewing.',
  '{DIRECTOR} has created something genuinely memorable.',
  'A remarkable debut that showcases serious talent.',
  '{DIRECTOR} delivers a film worthy of attention.',
  'A strong addition to contemporary {GENRE}.',
  'This is confident filmmaking from start to finish.',
  '{DIRECTOR} demonstrates filmmaking maturity beyond experience.',
  'This establishes {DIRECTOR} as a serious talent.',
];

const QUALITIES_CLIENT = [
  'visual storytelling','emotional depth','technical precision','narrative clarity',
  'atmospheric tension','character development','thematic richness','cinematic vision',
  'authentic performances','careful pacing','visual composition','tonal control',
];

function randomChoice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function parseDirectorNames(str) {
  return String(str || '').split(',').map(n => n.trim()).filter(Boolean);
}

function formatNames(str) {
  const names = parseDirectorNames(str);
  if (names.length === 0) return 'the director';
  if (names.length === 1) return names[0];
  if (names.length === 2) return names[0] + ' and ' + names[1];
  return names.slice(0, -1).join(', ') + ', and ' + names[names.length - 1];
}

function escapeRegex(str) {
  return String(str || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function applyDirectorAgreement(text, director, isPlural) {
  if (!isPlural) return text;

  let out = text;
  const directVerbPairs = [
    ['is', 'are'],
    ['has', 'have'],
    ['demonstrates', 'demonstrate'],
    ['creates', 'create'],
    ['crafts', 'craft'],
    ['delivers', 'deliver'],
    ['proves', 'prove'],
    ['shows', 'show'],
    ['reveals', 'reveal'],
    ['finds', 'find'],
    ['situates', 'situate'],
    ['frames', 'frame'],
    ['uses', 'use'],
    ['builds', 'build'],
    ['returns', 'return'],
    ['approaches', 'approach'],
    ['balances', 'balance'],
    ['navigates', 'navigate'],
    ['examines', 'examine'],
    ['positions', 'position'],
    ['treats', 'treat'],
    ['anchors', 'anchor'],
    ['foregrounds', 'foreground'],
    ['commits', 'commit'],
    ['keeps', 'keep'],
    ['opts', 'opt'],
    ['maintains', 'maintain'],
    ['prioritizes', 'prioritize'],
    ['confirms', 'confirm'],
    ['configures', 'configure']
  ];

  directVerbPairs.forEach(([singular, plural]) => {
    const rx = new RegExp(escapeRegex(director) + ' ' + singular + '\\b', 'g');
    out = out.replace(rx, director + ' ' + plural);
  });

  out = out
    .replace(new RegExp('\\bdirector ' + escapeRegex(director) + '\\b', 'g'), 'directors ' + director)
    .replace(new RegExp('\\bDirector ' + escapeRegex(director) + '\\b', 'g'), 'Directors ' + director)
    .replace(/\ba promising filmmaker\b/g, 'promising filmmakers')
    .replace(/\ba filmmaker with serious potential\b/g, 'filmmakers with serious potential')
    .replace(/\ba filmmaker to watch\b/g, 'filmmakers to watch');

  return out;
}

function normalizeReviewText(text) {
  let out = String(text || '')
    .replace(/\s+/g, ' ')
    .replace(/,\s+(that\b)/gi, ' $1')
    .replace(/\s+([,.;:!?])/g, '$1')
    .replace(/([,.;:!?])([^\s])/g, '$1 $2')
    .replace(/\.\s*\./g, '.')
    .trim();

  out = out.replace(/([.!?]\s+)([a-z])/g, (_, p1, p2) => p1 + p2.toUpperCase());
  if (out && !/[.!?]$/.test(out)) out += '.';
  return out;
}

function getMiddleFragmentLead(fragment) {
  const s = String(fragment || '').trim().toLowerCase();
  if (s.startsWith('through ')) return 'through';
  if (s.startsWith('with ')) return 'with';
  if (s.startsWith('while ')) return 'while';
  if (s.startsWith('that ')) return 'that';
  return 'other';
}

function getMiddleFragmentFirstWord(fragment) {
  const m = String(fragment || '').trim().toLowerCase().match(/^([a-z]+)/);
  return m && m[1] ? m[1] : '';
}

function pickMiddleSentencesClient() {
  const selected = [];
  const usedText = new Set();
  const usedLead = new Set();
  const usedFirstWord = new Set();
  let attempts = 0;

  while (selected.length < 3 && attempts < 300) {
    attempts += 1;
    const candidate = randomChoice(MIDDLES_CLIENT);
    if (!candidate || usedText.has(candidate)) continue;
    const lead = getMiddleFragmentLead(candidate);
    const firstWord = getMiddleFragmentFirstWord(candidate);
    if (lead !== 'other' && usedLead.has(lead)) continue;
    if (firstWord && usedFirstWord.has(firstWord)) continue;
    usedText.add(candidate);
    if (lead !== 'other') usedLead.add(lead);
    if (firstWord) usedFirstWord.add(firstWord);
    selected.push(candidate);
  }

  attempts = 0;
  while (selected.length < 3 && attempts < 300) {
    attempts += 1;
    const candidate = randomChoice(MIDDLES_CLIENT);
    if (!candidate || usedText.has(candidate)) continue;
    const firstWord = getMiddleFragmentFirstWord(candidate);
    if (firstWord && usedFirstWord.has(firstWord)) continue;
    usedText.add(candidate);
    if (firstWord) usedFirstWord.add(firstWord);
    selected.push(candidate);
  }

  attempts = 0;
  while (selected.length < 3 && attempts < 300) {
    attempts += 1;
    const candidate = randomChoice(MIDDLES_CLIENT);
    if (!candidate || usedText.has(candidate)) continue;
    usedText.add(candidate);
    selected.push(candidate);
  }

  selected.sort((a, b) => {
    const aThat = getMiddleFragmentLead(a) === 'that' ? 0 : 1;
    const bThat = getMiddleFragmentLead(b) === 'that' ? 0 : 1;
    return aThat - bThat;
  });

  return selected;
}

function buildReviewSentenceClient(opening, middles) {
  let out = String(opening || '');
  (Array.isArray(middles) ? middles : []).forEach((fragment, idx) => {
    if (!fragment) return;
    const lead = getMiddleFragmentLead(fragment);
    if (idx === 0 || lead === 'that') {
      out += ' ' + fragment;
    } else {
      out += ', ' + fragment;
    }
  });
  return out;
}

function generateReview(formData) {
  const opening = randomChoice(OPENINGS_CLIENT);
  const middles = pickMiddleSentencesClient();
  const closing = randomChoice(CLOSINGS_CLIENT);
  const genreAdjs = GENRE_ADJECTIVES_CLIENT[formData.genre] || ['compelling','engaging','thoughtful'];
  const genreAdj = randomChoice(genreAdjs);
  const quality1 = randomChoice(QUALITIES_CLIENT);
  const quality2 = randomChoice(QUALITIES_CLIENT.filter(q => q !== quality1));
  const directorNames = parseDirectorNames(formData.director);
  const isPluralDirector = directorNames.length > 1;
  const director = formatNames(formData.director);

  let review = `${buildReviewSentenceClient(opening, middles)}. ${closing}`;
  review = review
    .replace(/{TITLE}/g, formData.title || 'this film')
    .replace(/{DIRECTOR}/g, director)
    .replace(/{GENRE}/g, (formData.genre || 'film').toLowerCase())
    .replace(/{GENRE_ADJ}/g, genreAdj)
    .replace(/{QUALITY}/g, quality1)
    .replace(/{QUALITY}/g, quality2);

  review = applyDirectorAgreement(review, director, isPluralDirector);
  return normalizeReviewText(review);
}

// ══════════════════════════════════════════════════════════════
// FILMS SEARCH + FILTER
// ══════════════════════════════════════════════════════════════
function applyFilters() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  const genre = document.getElementById('filterGenre').value;
  const status = document.getElementById('filterStatus').value;
  const filtered = films.filter(f => {
    const matchQ = !q || f.title.toLowerCase().includes(q) || f.director.toLowerCase().includes(q);
    const matchGenre = !genre || f.genre === genre;
    const matchStatus = !status || (status === 'live' && f.live) || (status === 'hidden' && !f.live);
    return matchQ && matchGenre && matchStatus;
  });
  renderFilmsTable(filtered);
}

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('filterGenre').addEventListener('change', applyFilters);
document.getElementById('filterStatus').addEventListener('change', applyFilters);

// ══════════════════════════════════════════════════════════════
// TOGGLE LIVE / HIDDEN
// ══════════════════════════════════════════════════════════════
async function toggleFilm(id, currentlyLive, tr) {
  try {
    const res = await fetch(`${API_BASE}/admin?action=toggle&id=${id}`, {
      method: 'PUT',
      headers: { 'x-admin-password': adminPassword }
    });
    if (!res.ok) throw new Error();
    const data = await res.json();
    const film = films.find(f => { const fid = f._id?.$oid || f._id?.toString() || f._id; return fid === id; });
    if (film) film.live = data.live;
    const badge = tr.querySelector('.badge');
    badge.className = data.live ? 'badge badge-live' : 'badge badge-hidden';
    badge.textContent = data.live ? 'Live' : 'Hidden';
    const toggleBtn = tr.querySelector('.btn-toggle');
    toggleBtn.className = data.live ? 'btn btn-toggle is-live' : 'btn btn-toggle is-hidden';
    toggleBtn.textContent = data.live ? 'Hide' : 'Show';
    showToast(data.live ? 'Film set to live' : 'Film hidden', 'success');
  } catch {
    showToast('Failed to update status', 'error');
  }
}

// ══════════════════════════════════════════════════════════════
// EDIT MODAL
// ══════════════════════════════════════════════════════════════
const EDITABLE_FIELDS = [
  { key: 'title', label: 'Title', full: true },
  { key: 'director', label: 'Director' },
  { key: 'writer', label: 'Writer' },
  { key: 'producer', label: 'Producer' },
  { key: 'genre', label: 'Genre', type: 'select', options: ['Drama','Comedy','Documentary','Horror','Sci-Fi','Thriller','Animation','Experimental'] },
  { key: 'runtime', label: 'Runtime' },
  { key: 'logline', label: 'Logline', full: true, textarea: true },
  { key: 'review', label: 'Review', full: true, textarea: true, rows: 5 },
  { key: 'filmLink', label: 'Film link', full: true },
  { key: 'thumbnail', label: 'Thumbnail URL', full: true },
  { key: 'twitter', label: 'Twitter handle' },
  { key: 'onlinePremiere', label: 'Online premiere?' },
  { key: 'directorStatement', label: 'Director statement', full: true, textarea: true },
  { key: 'cast', label: 'Cast', full: true },
  { key: 'language', label: 'Language' },
];

function buildEmptyFilmDraft() {
  return {
    title: '',
    director: '',
    writer: '',
    producer: '',
    genre: 'Drama',
    runtime: '',
    logline: '',
    review: '',
    filmLink: '',
    thumbnail: '',
    twitter: '',
    onlinePremiere: '',
    directorStatement: '',
    cast: '',
    language: '',
    slug: '',
    pending: false,
    live: true,
    accepted: true,
    timestamp: new Date().toISOString()
  };
}

function slugifyTitle(value) {
  return String(value || '')
    .toLowerCase()
    .trim()
    .replace(/['"]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '') || 'untitled';
}

function getEditFormValues() {
  const inputs = document.getElementById('editForm').querySelectorAll('[data-key]');
  const values = {};
  inputs.forEach(inp => { values[inp.dataset.key] = inp.value || inp.textContent || ''; });
  return values;
}

function extractYouTubeIdClient(url) {
  const str = String(url || '');
  const patterns = [
    /youtube\.com\/watch\?v=([^&\s]+)/i,
    /youtu\.be\/([^?&\s]+)/i,
    /youtube\.com\/embed\/([^?&\s]+)/i
  ];
  for (const p of patterns) {
    const m = str.match(p);
    if (m && m[1]) return m[1];
  }
  return '';
}

function extractVimeoIdClient(url) {
  try {
    const parsed = new URL(String(url || ''));
    const parts = parsed.pathname.split('/').filter(Boolean);
    if (parts[0] && /^\d+$/.test(parts[0])) return parts[0];
  } catch (_) {}
  const m = String(url || '').match(/vimeo\.com\/(\d+)/i);
  return m && m[1] ? m[1] : '';
}

async function deriveThumbnailFromVideoLink(url) {
  const u = String(url || '').trim();
  if (!u) return '';

  const ytId = extractYouTubeIdClient(u);
  if (ytId) {
    const variants = ['maxresdefault', 'hq720', 'sddefault', 'hqdefault'];
    for (const name of variants) {
      const candidate = `https://i.ytimg.com/vi/${ytId}/${name}.jpg`;
      const ok = await new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          // Filter out tiny placeholders/error thumbs.
          resolve((img.naturalWidth || 0) >= 320 && (img.naturalHeight || 0) >= 180);
        };
        img.onerror = () => resolve(false);
        img.src = candidate;
      });
      if (ok) return candidate;
    }
    return `https://i.ytimg.com/vi/${ytId}/hqdefault.jpg`;
  }

  const vimeoId = extractVimeoIdClient(u);
  if (vimeoId) {
    try {
      const oembedUrl = 'https://vimeo.com/api/oembed.json?url=' + encodeURIComponent(u) + '&width=1280';
      const res = await fetch(oembedUrl);
      if (res.ok) {
        const data = await res.json();
        if (data && data.thumbnail_url) {
          return String(data.thumbnail_url).replace(/_\d+x\d+\./, '_1280.');
        }
      }
    } catch (_) {
      // Fall back to a predictable thumbnail service if Vimeo oEmbed is blocked/unavailable.
    }
    return `https://vumbnail.com/${vimeoId}.jpg`;
  }

  return '';
}

function openEditModal(film, options = {}) {
  editingFilm = film;
  modalReadOnly = !!options.readOnly;
  isCreatingFilm = !!options.create;
  const form = document.getElementById('editForm');
  const saveBtn = document.getElementById('modalSave');
  const cancelBtn = document.getElementById('modalCancel');
  const generateBtn = document.getElementById('modalGenerateReview');
  while (form.firstChild) form.removeChild(form.firstChild);
  const prefix = options.titlePrefix || (modalReadOnly ? 'Viewing' : (isCreatingFilm ? 'Add Film' : 'Editing'));
  document.getElementById('modalTitle').textContent = prefix + ': ' + (film.title || 'Untitled');
  EDITABLE_FIELDS.forEach(field => {
    const group = document.createElement('div');
    group.className = field.full ? 'form-group full' : 'form-group';
    const label = document.createElement('label');
    label.textContent = field.label;
    let input;
    if (field.type === 'select') {
      input = document.createElement('select');
      field.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt; option.textContent = opt;
        if (film[field.key] === opt) option.selected = true;
        input.appendChild(option);
      });
    } else if (field.textarea) {
      input = document.createElement('textarea');
      input.rows = field.rows || 3;
      input.textContent = film[field.key] || '';
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.value = film[field.key] || '';
    }
    input.dataset.key = field.key;
    if (modalReadOnly) {
      input.disabled = true;
      input.readOnly = true;
      input.style.opacity = '0.85';
      input.style.cursor = 'default';
    }
    group.appendChild(label);
    group.appendChild(input);
    if (field.key === 'review' && !modalReadOnly) {
      const row = document.createElement('div');
      row.className = 'actions inline-field-action';
      const genBtn = document.createElement('button');
      genBtn.type = 'button';
      genBtn.className = 'btn btn-edit';
      genBtn.id = 'modalGenerateReview';
      genBtn.textContent = 'Generate review';
      row.appendChild(genBtn);
      group.appendChild(row);
    }
    form.appendChild(group);
  });
  saveBtn.style.display = modalReadOnly ? 'none' : 'inline-flex';
  saveBtn.textContent = isCreatingFilm ? 'Create film' : 'Save changes';
  cancelBtn.textContent = modalReadOnly ? 'Close' : 'Cancel';
  document.getElementById('editModal').classList.add('open');
}

document.getElementById('modalCancel').addEventListener('click', closeEditModal);
document.getElementById('editModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditModal(); });
function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  document.getElementById('modalSave').style.display = 'inline-flex';
  document.getElementById('modalSave').textContent = 'Save changes';
  document.getElementById('modalCancel').textContent = 'Cancel';
  editingFilm = null;
  modalReadOnly = false;
  isCreatingFilm = false;
}

document.getElementById('addFilmBtn').addEventListener('click', () => {
  openEditModal(buildEmptyFilmDraft(), { create: true, titlePrefix: 'Add Film' });
});

document.getElementById('editForm').addEventListener('click', async (e) => {
  const btn = e.target.closest('#modalGenerateReview');
  if (!btn) return;
  if (!editingFilm || modalReadOnly) return;
  const values = getEditFormValues();
  const reviewField = document.getElementById('editForm').querySelector('[data-key="review"]');
  if (!reviewField) return;
  btn.disabled = true;
  const prevLabel = btn.textContent;
  btn.textContent = 'Generating…';
  try {
    const res = await fetch(`${API_BASE}/admin?action=generateReview`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-admin-password': adminPassword
      },
      body: JSON.stringify(values)
    });
    if (!res.ok) throw new Error();
    const data = await res.json();
    reviewField.value = data.review || '';
  } catch {
    // Fallback to local generator if API route isn't deployed yet.
    reviewField.value = generateReview(values);
    showToast('Used local review generator (deploy API to use full set)', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = prevLabel;
  }
});

document.getElementById('modalSave').addEventListener('click', async () => {
  if (!editingFilm || modalReadOnly) return;
  const updates = getEditFormValues();
  const btn = document.getElementById('modalSave');
  const originalLabel = btn.textContent;
  btn.disabled = true; btn.textContent = isCreatingFilm ? 'Creating…' : 'Saving…';
  try {
    if (!String(updates.thumbnail || '').trim() && String(updates.filmLink || '').trim()) {
      const derivedThumb = await deriveThumbnailFromVideoLink(updates.filmLink);
      if (derivedThumb) {
        updates.thumbnail = derivedThumb;
        const thumbInput = document.getElementById('editForm').querySelector('[data-key="thumbnail"]');
        if (thumbInput) thumbInput.value = derivedThumb;
      }
    }

    if (!updates.slug) updates.slug = slugifyTitle(updates.title);
    if (!updates.timestamp) updates.timestamp = new Date().toISOString();
    updates.pending = false;
    updates.accepted = true;

    let res;
    if (isCreatingFilm) {
      updates.live = true;
      res = await fetch(`${API_BASE}/admin?action=create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-admin-password': adminPassword },
        body: JSON.stringify(updates)
      });
    } else {
      const mongoId = editingFilm._id?.$oid || editingFilm._id?.toString() || editingFilm._id;
      res = await fetch(`${API_BASE}/admin?action=update&id=${mongoId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'x-admin-password': adminPassword },
        body: JSON.stringify(updates)
      });
    }
    if (!res.ok) throw new Error();
    if (isCreatingFilm) {
      await loadFilms();
    } else {
      Object.assign(editingFilm, updates);
    }
    closeEditModal();
    applyFilters();
    showToast(isCreatingFilm ? 'Film created' : 'Film saved', 'success');
  } catch {
    showToast(isCreatingFilm ? 'Failed to create film' : 'Failed to save', 'error');
  }
  finally { btn.disabled = false; btn.textContent = originalLabel; }
});

// ══════════════════════════════════════════════════════════════
// DELETE CONFIRM
// ══════════════════════════════════════════════════════════════
function openConfirmDelete(id, title) {
  deletingId = id;
  document.getElementById('confirmFilmName').textContent = `"${title}" will be permanently deleted.`;
  document.getElementById('confirmModal').classList.add('open');
}

document.getElementById('confirmCancel').addEventListener('click', () => {
  document.getElementById('confirmModal').classList.remove('open');
  deletingId = null;
});

document.getElementById('confirmDelete').addEventListener('click', async () => {
  if (!deletingId) return;
  const btn = document.getElementById('confirmDelete');
  btn.disabled = true; btn.textContent = 'Deleting…';
  try {
    const res = await fetch(`${API_BASE}/admin?action=delete&id=${deletingId}`, {
      method: 'DELETE',
      headers: { 'x-admin-password': adminPassword }
    });
    if (!res.ok) throw new Error();
    films = films.filter(f => { const fid = f._id?.$oid || f._id?.toString() || f._id; return fid !== deletingId; });
    document.getElementById('confirmModal').classList.remove('open');
    deletingId = null;
    applyFilters();
    showToast('Film deleted', 'success');
  } catch { showToast('Failed to delete', 'error'); }
  finally { btn.disabled = false; btn.textContent = 'Delete'; }
});

// ══════════════════════════════════════════════════════════════
// TOAST
// ══════════════════════════════════════════════════════════════
let toastTimer;
function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { toast.className = ''; }, 3000);
}
</script>
</body>
</html>
